{% extends "admin/change_list.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
    h1, h2, h3, h4, h5 {
        font-weight: bold;
    }

    h1 {
        margin: 0 0 20px;
        font-weight: 300;
        font-size: 20px !important;
        color: var(--body-quiet-color);
    }

</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
{% endblock %}

{% block object-tools-items %}
    {{ block.super }}
    <li>
        <a href="#" class="addlink" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Convert Currency
        </a>
    </li>
{% endblock %}

{% block content %}
    {{ block.super }}

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Currency Conversion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form -->
                    <div id="currency-form-section">
                        <form id="convert-currency-form" class="p-4 bg-light shadow rounded-3">
                            {% csrf_token %}
                            <h3 class="text-center mb-4 text-primary fw-bold">
                                <i class="bi bi-currency-exchange"></i> Currency Converter
                            </h3>
                        
                            <div class="mb-3 position-relative">
                                <label for="source_currency" class="form-label text-muted">Source Currency <span class="text-danger">(3 letters)</span>:</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white">
                                        <i class="bi bi-currency-dollar"></i>
                                    </span>
                                    <input type="text" class="form-control border-primary" id="source_currency" name="source_currency" required maxlength="3" placeholder="e.g., USD">
                                </div>
                                <div class="invalid-feedback">Please enter a valid 3-letter currency code.</div>
                            </div>
                        
                            <div class="mb-3 position-relative">
                                <label for="exchanged_currency" class="form-label text-muted">Exchanged Currency <span class="text-danger">(3 letters)</span>:</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-success text-white">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </span>
                                    <input type="text" class="form-control border-success" id="exchanged_currency" name="exchanged_currency" required maxlength="3" placeholder="e.g., EUR">
                                </div>
                                <div class="invalid-feedback">Please enter a valid 3-letter currency code.</div>
                            </div>
                        
                            <div class="mb-3 position-relative">
                                <label for="amount" class="form-label text-muted">Amount:</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-warning text-white">
                                        <i class="bi bi-cash-stack"></i>
                                    </span>
                                    <input type="number" class="form-control border-warning" id="amount" name="amount" required min="0.01" step="0.01" placeholder="Enter amount">
                                </div>
                                <div class="invalid-feedback">Please enter a positive number.</div>
                            </div>
                        
                            <div class="modal-footer d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Close
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-arrow-right-circle"></i> Convert
                                </button>
                            </div>
                        </form>
                    </div>
    


                    <!-- Result Section (hidden initially) -->
                    <div id="conversion-result-section" style="display: none;">
                        <div class="text-center mb-3">
                            <h3 class="text-primary fw-bold">Currency Conversion Results</h3>
                        </div>
                        <div class="card bg-light shadow-sm p-4">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <p class="text-muted mb-1">Source Currency</p>
                                        <h4 id="source-currency" class="fw-bold text-info"></h4>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1">Exchanged Currency</p>
                                        <h4 id="exchanged-currency" class="fw-bold text-info"></h4>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <p class="text-muted mb-1">Original Amount</p>
                                        <h4 id="original-amount" class="fw-bold text-success"></h4>
                                    </div>
                                    <div class="col-6">
                                        <p class="text-muted mb-1">Converted Amount</p>
                                        <h4 id="converted-amount" class="fw-bold text-success"></h4>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <p class="text-muted mb-1">Conversion Rate</p>
                                        <h4 id="conversion-rate" class="fw-bold text-primary"></h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer mt-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="convert-again-btn">Convert Again</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
<script>
    $(document).ready(function () {
    document.documentElement.setAttribute('data-theme', 'light');

        function resetForm() {
            $("#convert-currency-form")[0].reset();
            $(".form-control").removeClass("is-invalid");
        }

        function validateCurrencyCode(value) {
            return /^[A-Za-z]{3}$/.test(value);
        }
    
        function validateAmount(value) {
            return value > 0;
        }
    
        $("#convert-currency-form").submit(function (event) {
            event.preventDefault();
    
            let source_currency = $("#source_currency").val().toUpperCase();
            let exchanged_currency = $("#exchanged_currency").val().toUpperCase();
            let amount = parseFloat($("#amount").val());
    
            let isValid = true;
    
            if (!validateCurrencyCode(source_currency)) {
                $("#source_currency").addClass("is-invalid");
                isValid = false;
            } else {
                $("#source_currency").removeClass("is-invalid");
            }
    
            if (!validateCurrencyCode(exchanged_currency)) {
                $("#exchanged_currency").addClass("is-invalid");
                isValid = false;
            } else {
                $("#exchanged_currency").removeClass("is-invalid");
            }
    
            if (!validateAmount(amount)) {
                $("#amount").addClass("is-invalid");
                isValid = false;
            } else {
                $("#amount").removeClass("is-invalid");
            }
    
            if (!isValid) {
                return;
            }
    
            fetch('/api/v1/convert_currency/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token }}",
                },
                body: JSON.stringify({
                    source_currency: source_currency,
                    exchanged_currency: exchanged_currency,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    $("#convert-currency-form").hide();
                    $("#conversion-result-section").show();

                    // Populate the result fields with the API data
                    $("#source-currency").text(data.source_currency);
                    $("#exchanged-currency").text(data.exchanged_currency);
                    $("#original-amount").text(data.original_amount);
                    $("#converted-amount").text(data.converted_amount);
                    $("#conversion-rate").text(data.rate);

                    $('#exampleModal').modal('show');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert("An error occurred while converting currency.");
            });

            $("#convert-again-btn").click(function() {
                $("#conversion-result-section").hide();
                $("#convert-currency-form").show();
                $('#convert-currency-form').trigger("reset");
            });

            $('#exampleModal').on('hidden.bs.modal', function () {
                resetForm();
                $('#convert-currency-form').show();
                $("#conversion-result-section").hide();

            });
        });
    });
</script>
{% endblock %}
